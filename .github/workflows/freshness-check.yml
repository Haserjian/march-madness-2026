name: Freshness & Integrity Check

on:
  # Run at 14:00 UTC daily (before most NCAA tipoffs)
  schedule:
    - cron: "0 14 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PyNaCl for signature verification
        run: pip install pynacl

      - name: Check today's attestation
        id: check
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          echo "date=$TODAY" >> "$GITHUB_OUTPUT"

          ERRORS=""

          # 1. Check index.html exists
          if [ ! -f index.html ]; then
            ERRORS="$ERRORS\n- index.html missing"
          fi

          # 2. Check index.json exists
          if [ ! -f index.json ]; then
            ERRORS="$ERRORS\n- index.json missing"
          fi

          # 3. Check today's attestation exists and verify signature
          ATT="attestations/${TODAY}.json"
          if [ -f "$ATT" ]; then
            echo "attestation=true" >> "$GITHUB_OUTPUT"

            # Verify Ed25519 signature using embedded public key
            VERIFY_RESULT=$(python3 -c "
          import base64, hashlib, json, sys
          try:
              from nacl.signing import VerifyKey
          except ImportError:
              print('SKIP: PyNaCl not available')
              sys.exit(0)

          att = json.load(open('$ATT'))

          # Check required crypto fields
          pubkey_b64 = att.get('signer_pubkey', '')
          sig_b64 = att.get('signature', '')
          if not pubkey_b64 or not sig_b64:
              print('FAIL: missing signer_pubkey or signature')
              sys.exit(1)

          # Verify signature
          unsigned = {k: v for k, v in att.items()
                      if k not in ('signature', 'signer_pubkey', 'signer_pubkey_fingerprint')}
          canonical = json.dumps(unsigned, sort_keys=True, separators=(',', ':')).encode('utf-8')
          try:
              vk = VerifyKey(base64.b64decode(pubkey_b64))
              vk.verify(canonical, base64.b64decode(sig_b64))
              print('PASS')
          except Exception as e:
              print(f'FAIL: signature verification failed: {e}')
              sys.exit(1)
          ")
            if [ $? -ne 0 ]; then
              ERRORS="$ERRORS\n- attestation signature verification failed: $VERIFY_RESULT"
            fi

            # Check conditional fields based on n_games
            N_GAMES=$(python3 -c "import json; print(json.load(open('$ATT')).get('n_games', 0))")

            if [ "$N_GAMES" -gt 0 ]; then
              # Games exist: predictions_hash must be present
              PRED_HASH=$(python3 -c "import json; print(json.load(open('$ATT')).get('predictions_hash') or '')")
              if [ -z "$PRED_HASH" ]; then
                ERRORS="$ERRORS\n- attestation missing predictions_hash (${N_GAMES} games expected)"
              fi
            fi
            # locked_at can legitimately be null (pre-lock or no games)

          else
            echo "attestation=false" >> "$GITHUB_OUTPUT"
            ERRORS="$ERRORS\n- attestation missing for $TODAY"
          fi

          if [ -n "$ERRORS" ]; then
            echo "status=fail" >> "$GITHUB_OUTPUT"
            # Escape for multiline
            echo "errors<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$ERRORS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "status=pass" >> "$GITHUB_OUTPUT"
            echo "All checks passed for $TODAY"
          fi

      - name: Open issue on failure
        if: steps.check.outputs.status == 'fail'
        uses: actions/github-script@v7
        with:
          script: |
            const date = '${{ steps.check.outputs.date }}';
            const errors = `${{ steps.check.outputs.errors }}`;
            const title = `Pipeline freshness alert: ${date}`;

            // Check if issue already exists for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'freshness-alert',
            });
            const existing = issues.data.find(i => i.title === title);
            if (existing) {
              console.log(`Issue already exists: #${existing.number}`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `## Freshness check failed for ${date}\n\n${errors}\n\nThis means the local pipeline did not run or mirror did not complete before the daily check.\n\n**Action**: Run \`python scripts/march_madness/run_day.py --mirror\` from the ccio repo.`,
              labels: ['freshness-alert'],
            });
