name: Freshness & Integrity Check

on:
  # Run at 14:00 UTC daily (before most NCAA tipoffs)
  schedule:
    - cron: "0 14 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check today's attestation
        id: check
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          echo "date=$TODAY" >> "$GITHUB_OUTPUT"

          ERRORS=""

          # 1. Check index.html exists
          if [ ! -f index.html ]; then
            ERRORS="$ERRORS\n- index.html missing"
          fi

          # 2. Check index.json exists
          if [ ! -f index.json ]; then
            ERRORS="$ERRORS\n- index.json missing"
          fi

          # 3. Check today's attestation exists
          ATT="attestations/${TODAY}.json"
          if [ -f "$ATT" ]; then
            echo "attestation=true" >> "$GITHUB_OUTPUT"

            # 4. Verify attestation has required fields
            for field in predictions_hash locked_at signature signer_pubkey; do
              val=$(python3 -c "import json; d=json.load(open('$ATT')); print(d.get('$field',''))")
              if [ -z "$val" ] || [ "$val" = "None" ]; then
                ERRORS="$ERRORS\n- attestation missing field: $field"
              fi
            done
          else
            echo "attestation=false" >> "$GITHUB_OUTPUT"
            ERRORS="$ERRORS\n- attestation missing for $TODAY"
          fi

          if [ -n "$ERRORS" ]; then
            echo "status=fail" >> "$GITHUB_OUTPUT"
            # Escape for multiline
            echo "errors<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$ERRORS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "status=pass" >> "$GITHUB_OUTPUT"
            echo "All checks passed for $TODAY"
          fi

      - name: Open issue on failure
        if: steps.check.outputs.status == 'fail'
        uses: actions/github-script@v7
        with:
          script: |
            const date = '${{ steps.check.outputs.date }}';
            const errors = `${{ steps.check.outputs.errors }}`;
            const title = `Pipeline freshness alert: ${date}`;

            // Check if issue already exists for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'freshness-alert',
            });
            const existing = issues.data.find(i => i.title === title);
            if (existing) {
              console.log(`Issue already exists: #${existing.number}`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `## Freshness check failed for ${date}\n\n${errors}\n\nThis means the local pipeline did not run or mirror did not complete before the daily check.\n\n**Action**: Run \`python scripts/march_madness/run_day.py --mirror\` from the ccio repo.`,
              labels: ['freshness-alert'],
            });
